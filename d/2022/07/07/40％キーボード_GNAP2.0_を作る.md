---
title: 40％キーボード GNAP2.0 を作る
aliases:
  - 40％キーボード_GNAP2.0_を作る
tags:
  - d/2022/07/07
---

GNAP 2.0 とは
================================================================================

- 40% キーボード
  - 実際のキー数 47
- Pro Micro 実装
- QMK 対応
- ロウスタッガート
  - 全段 0.25U ズレ(HHKの配列)

こういう理由で作ってみたいと思った

部品調達
================================================================================
PCB
--------------------------------------------------------------------------------
[di0ib/tmk\_keyboard: Keyboard firmwares for Atmel AVR and Cortex\-M \- tmk\_keyboard \- git\.40percent\.club](https://git.40percent.club/di0ib/tmk_keyboard/src/branch/master/keyboard/gnap/pcb)

ここに PCB の Gerber ファイルがあるのでいつもの中国の業者に発注した。

次に [PCB Prototype & PCB Fabrication Manufacturer - JLCPCB](https://jlcpcb.com/) このサイトに行って、右上の order now をクリックして、↑の gerber ファイルをアップロードする。 そこで色々パラメータを選んで発注する。選ぶのは数と基盤の色ぐらいである。

10枚発注して 25USD。

設計としてケースが無い cap, switch, PCB, 背面実装 という感じになる。
背面の実装部分をカバーするために PCB 同サイズのプレートが必要になるのだが、 PCB 自体がたったの 2.5USD なので、
同じ基板を底面プレートとしても使ってやるというという考え。

長くても2週間ぐらいで届く。



スペーサー
--------------------------------------------------------------------------------
真鍮製のスペーサーを2枚の PCB の間に仕込む。

長さ 10mm x 18, M2 真鍮ネジ 36本

家にあった在庫から使う。結構な本数が必要である。

Pro Micro
--------------------------------------------------------------------------------
家にころがってたのをそのまま使った。1個。

この GNAP は本当は Pro Micro を2つ実装に使うのだが、配線図を見る限り、LED を光らせなければ1個でよさそうなので、
1個だけ使う。

ピンヘッダ
--------------------------------------------------------------------------------
Pro Micro に付属してきたやつをそのまま使う。

この GNAP というキーボードはメンテ性が悪いので、使えるならば例のコンスルーを使ったほうがよい。


ダイオード
--------------------------------------------------------------------------------
`1n4148` のダイオードを使う。これも家に在庫が大量にあるのでそれを使う。

キーの数だけ必要なので全部で 47個 必要になる。


スイッチ
--------------------------------------------------------------------------------
定番の Cherry MX 互換のスイッチを使う。

GNAP は PCB マウント(キー自体をはんだ付け固定力で保持する)なので 5pin のスイッチが必要になる。
3pin でも作れはするが、端子の位置決め精度が悪いので気をつけないと水平垂直がズレる。

キーの数は 47個

今回は家にあった在庫、Gateron 白軸 を使う、リニアの 35g という仕様で、赤軸よりも軽い。



キーキャップ
--------------------------------------------------------------------------------
特殊なサイズのキーは特に無いので、100％のフルキーセットがあればどうにかなる。
これも家にあった在庫で適当に済ました。

一つだけ特殊なキーが必要で、2.25U のスペースキー。
最下段のプロファイルの 2.25U のキーは通常のキーセットにはまず無いので、ここだけは OEM の shift 逆付けで対処。



スタビライザー2U
--------------------------------------------------------------------------------
最下段中央に1個だけスタビが必要なキーがある。2U用 1個。

地味に高い部品。家にあった在庫で対応。 PCB 固定のネジ式。

必須ではないが地味に重要で地味に高い部品。


mini USB ソケット
--------------------------------------------------------------------------------
Pro Micro の microUSB を変換して miniUSB とするようなので、そのためのソケットが必要になる。

この mini USB のソケットモジュールは保持用の爪が両脇に1個ずつ、信号用のピンが垂直方向に五輪のように並んでいるモノになる。このモジュールはいくつか種類があるので、それに合致するモノを手に入れる。1個。

自分はいろんなピン形状の mini USB ソケットを100個ぐらいまとめて買って、その中から合致するやつを選んだ。


micro USB ケーブル(データ)
--------------------------------------------------------------------------------
Pro Micro の ソケットから、mini USB にするためのケーブルとして micro USB ケーブルを使う。
データ通信するので必要なのはデータケーブル(4本線)である。

micro USB のプラグ部品から配線してもよいのだが、プラグ部品自体が手ではんだ付けするような用途で作られていない。
それより、配線済みのデータケーブルを切って使った方が楽

1本



まとめ
--------------------------------------------------------------------------------

| 部品 | 個数 | 単価 | 合計 | memo |
| --- | --- | --- | --- | --- |
| PCB | 2   | 2.5 USD | 5 USD | 2枚目は回路としてでなく単なるボトムプレートとして使う |
| スペーサー 5mm | 10 | 0.1 USD | 1 USD | 値段はあってないみたいなもんなので参考まで |
| M2 ネジ | 20 | 0.1 USD | 2 USD | スペーサーの固定に使用 |
| Pro Micro | 1 | 10 USD | 10 USD | 半導体不足なのか以前は 5 USD 程度だったのに |
| ダイオード | 47 | xxx | 1 USD | 安すぎてわからん |
| スイッチ | 47 | 




製作
================================================================================
ここでは PCB のキースイッチを取り付ける側を表、反対を裏として説明する。



ダイオードの取り付け
--------------------------------------------------------------------------------
47個のダイオードの足を PCB のスルーホールの幅に合わせて折る。折る用のゲージがあるのでそれがあると綺麗に折れる。

PCB 表面に長方形の一端が二重線になっているプリントがあるのでそこがダイオードの取り付け位置になる。
二重線になっている側がダイオードの太い黒線側になるようにする。

スルーホールに通して PCB 裏面からはんだ付けする。このはんだ付けは簡単なので、ここで練習する。

はんだ付けは、はんだごてをそのはんだ付けしたい部位に当てて温め、温度が上がったところで、はんだを入れ込んで溶かし馴染ませたら、一呼吸置いてはんだごてを離すという感じにする。


mini USB ソケットの取り付け
--------------------------------------------------------------------------------
後でも取り付けられるが、キーを取り付けてからだとはんだ付けが困難なので先にとりつけたほうがよい。
PCB 表面、右上角あたりにプリントがある。プリントは表面にあるが、実際のソケットは裏面から差し込む。

ソケット両脇の2つの穴は保持のためなので、回路では無い。ここは重要なので多めにガッチリはんだ付けする。

端子は非常に密度が高く配置されているのではんだ付けが難しい。
フラックスを使って細いはんだででさらっと済ませるとよいだろう。

ソケットをはんだ付けしたら、その直ぐ近くに露出している、4つ並んだ四角のランドがあるのでそこと導通確認する。
はんだ付け箇所は、2箇所、3箇所、と2段になっているが、1段目の右側は USB の ID 端子というやつで今回の状況では不要なのでそこはどこにも導通してない。


ピンヘッダの取り付け
--------------------------------------------------------------------------------
PCB 裏面に Pro Micro を取り付けるためのピンヘッダをはんだ付けする。
これもキースイッチをつけてからでははんだ付け困難なので先に行う。

ピンヘッダだけはんだ付けするのがポイントである。先に Pro Micro まではんだ付けしてしまうと、その背面にあるキースイッチがはんだ付けできなくなる。

このキーボードのメンテ性が極悪なのはこのためである。

ここで使うのは PCB 右側に Pro Micro を設置するためのピンヘッダである。
左側にあるのは LED 制御のための Pro Micro で今回は LED を光らせないので使わなくて OK
同様の理由で表面にプリントされている `R1` `R2` のような表記の抵抗も入れる必要が無い。

ここも 20 箇所もはんだ付けする必要があり、それなりに細かいので、フラックス多めで細いはんだで行う。

回路図を見て一番近いキーのランド、ダイオードと該当のピンヘッダが繋がっているかの導通チェックをする。
縦方向のチェックはダイオード側、横方向のチェックはスイッチのランドで行うようになると思う。

テスターの導通チェックではダイオードの機能チェック(向きは合っているか？)は出来ない場合があるのでここの導通チェックはその手前側でやる。


キースイッチの取り付け
--------------------------------------------------------------------------------
キースイッチの取り付け前に、ダイオードの向きが正しいかどうかをもう一度確認する。
キーを取り付けた後ではダイオードの修正が面倒になる。

47個の Cherry MX 互換のスイッチをとりつける。この PCB は PCB に直マウントなので、はんだの溶け込みを深くしてガッチリ目を意識。

角から進めると高さが揃うので作業が楽になる。

Pro Micro のとりつけ
--------------------------------------------------------------------------------
ここでもしつこくダイオードの向きを全部チェックする。特に Pro Micro 背面に隠れてしまうダイオード、スイッチの動作は必ずチェックする。この Pro Micro をランドやスルーホールを問題なく取り除くにはかなり難しいので間違えたら終了になる。

一応裏面はカプトンテープ等で絶縁しておいたほうがよいだろう。

ピンヘッダに Pro Micro を固定する。向きは mini USB ソケットから遠い側に Pro Micro の micro USB ソケットが来るようにする。

ピンヘッダのはんだづけ同様数が多くて細かいのでフラックスを使って素早く溶け込ませていく。


USB ケーブルの加工と取り付け
--------------------------------------------------------------------------------
PCB 上の mini USB ソケットから来るランドと、Pro Micro は Pro Micro の micro USB ソケットを介して接続する。

なので micro USB B プラグを用意してそこから配線を引き出してランドにはんだ付けする必要がある。

しかしプラグ単体で用意するのも難しいし、あの小さいプラグに配線するのも難易度が高い。

そのへんに転がっている、micro USB ケーブルを途中で切断しそれを流用するのが楽である。

USBケーブル内の配線には一応慣例的な色があるらしく

- 電源+ 赤
- GND 黒
- D+ 緑
- D- 白

で実装されているっぽい。手近なケーブルを切って使ったらそうなってたのでそれを信じてランドにはんだ付けする。
ここも細かいので、フラックスを使って、線、ランド両方に先に予備はんだをしておいて、一瞬溶かして付けると楽だろう。

ケーブルを Pro Micro に接続すればこれで一応キーボードとして完成する


QMK のインストール
--------------------------------------------------------------------------------
自作キーボードの定番である QMK をインストールする。

QMK をインストールしたら標準でくっついてくる、中から ut47 というキーボードのモノを使う。
ut47 は gnap の後継らしく、キー部分だけなら完全互換っぽいので、これを使う。

[qmk\_firmware/keyboards/40percentclub/ut47 at master · qmk/qmk\_firmware · GitHub](https://github.com/qmk/qmk_firmware/tree/master/keyboards/40percentclub/ut47)

ここの `default` をコピーして適当に名前をつける(ore)。

ビルドする

```console
$ make 40percentclub/ut47:ore
```


ズラズラ出てきてビルド完了。hex ファイルが出来上がる。

↑で出来上がったキーボードを USB で PC に接続する。

[Pro Micro Web Updater](https://sekigon-gonnoc.github.io/promicro-web-updater/index.html)

このサイトに行って、ビルドした hex ファイルを選択する。

Flash ボタンを押す。

ダイアログが開く。ここでおそらく現状の Arduino として認識されていることが確認できる。
ここで、Pro Micro の `RST` と `GND` 端子(隣り合っている)をクリップか何か金属でショートさせる。
これで Pro Micro が書き込みモードに入る

そうすると、ダイアログに新たな Arduino として出てくるので、それを選択する。

hex が書き込まれて、完了する。

これで gnap が完全にキーボードとして機能するようになったので、全部のキーが動作するのかを確認する。

確認できたら OK

QMK オリジナルマップの書き込み
--------------------------------------------------------------------------------
ビルド方法、インストール方法もわかったのでオリジナルマップを作る。

必要なのはとりあえず、RESET の機能を持ったマップになる。つまり `RST` `GND` ショートをやらなくても書き込みモードにできるマップである。

キーボードは裏面保護のために、ボトムプレートを取り付けることになるが、これをするとショートが難しくなるのでキー操作でそれができるようにしておくと楽ということだ。

適当にノリで作る

```c
[_BL] = LAYOUT(
  KC_ESC,  KC_Q,    KC_W,    KC_E,    KC_R,    KC_T,    KC_Y,    KC_U,    KC_I,    KC_O,    KC_P,    KC_BSPC,
  LT3_TAB, KC_A,    KC_S,    KC_D,    KC_F,    KC_G,    KC_H,    KC_J,    KC_K,    KC_L,    KC_SCLN, KC_QUOT,
  KC_LSFT, KC_Z,    KC_X,    KC_C,    KC_V,    KC_B,    KC_N,    KC_M,    KC_COMM, KC_DOT,  KC_SLSH, MT_RSFT_ENT,
  TO(_LL), KC_LALT, KC_LGUI, KC_APP,  MO(2),      KC_SPC,        MO(1),  KC_LEFT, KC_DOWN, KC_UP,   KC_RGHT
),

[_LL] = LAYOUT(
  RESET , XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
  XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
  XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
  XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX
),
```

defalut にあったベースレイヤーだけとりあえず残して、後は消す。オリジナルのレイヤーを1個追加して、左下隅のキーにそのレイヤーへの移動を割り当てる(`TO(_LL)`)。オリジナルレイヤーの左上隅のキーに RESET を割り当てる。

ビルドして同様にインストール。

キー操作で書き込みモードにできることを確認。

OK


スタビライザーの取り付け
--------------------------------------------------------------------------------
gnap は中央下段のキーだけスタビライザーを必要とするのでつける。

今回使ったのは PCB マウントのネジ式である。高級スタビライザーである。

各部にルブする。スタビライザーによってはルブしないとガチャガチャ音が酷かったりスムーズに動かなかったりするので、
必ずルブしたほうがよい。

まず、ブレ留めのシールを接地面に貼る。そこにくみ上げたスタビライザーをはめ込む。
奥がツメで手前がネジになるようにする。裏からワッシャーを噛ましてネジで締め上げる。

ここで実際に使うキーをハメてみてスムーズに上下するかどうかを確かめる。
PCB やスタビライザー、キーキャップの精度次第で、ここでスムーズに上下しない引っかかりが出てきたりする。
この場合スタビライザーをガチで締めすぎて遊びが無くなっている、もしくは歪みが出てしまっているためそうなったりするので、ネジを緩めることで緩和される可能性がある。




ボトムプレートの取り付け
--------------------------------------------------------------------------------
裏面を保護するためにボトムプレートを取り付ける。

今回は M2 の長さ 10mm の真鍮製のスペーサーを立てて、ボトムプレートをとりつける。
ボトムプレートは使った PCB と同じモノを利用する。回路は無駄になるが、穴位置が完全一致するので新たに発注したり、作ったりするよりも割安で確実である。どうせ PCB は少量で注文できないので。

今回 PCB を紫で作ったのでそれにゴールドの真鍮がよく映える。













































































































 










































































紆余曲折あって完了した。

gnap2.0 は調べると UT47 の version1 とほぼ互換らしいので、それを使う。

QMK firmware の中に `keyboards/40percentclub/ut47/keymaps/default` があるのでとりあえずコイツをビルドする。

[qmk\_firmware/keyboards/40percentclub/ut47/keymaps/default at master · qmk/qmk\_firmware · GitHub](https://github.com/qmk/qmk_firmware/tree/master/keyboards/40percentclub/ut47/keymaps/default)


```console
$ make 40percentclub/ut47:default
```

出来上がった hex を pro micro へ書き込む。

完成したキーボードを PC へ接続する。

[Pro Micro Web Updater](https://sekigon-gonnoc.github.io/promicro-web-updater/index.html)

このサイトにアクセスする。そして hex をアップロードして、flash ボタンを押す。

そうするとどのデバイスを flash するのかのダイアログが出る。

そのタイミングで pro micro の `RST` と `GND` ピン(隣り合っている)をマイナスドライバーか何かでショートさせる。
そうすると書き込むモードになる。ダイアログに選択肢として出てくるので選択する。

そうすると書き込まれるのでOK。

キーが動作することを確認する。UT47と互換なのは完全に確かめられた。


ではオリジナルを作るので `default` をコピーして `ore` を作る。


keymap を操作するが、まず 書き込みモードにするキーを設定して、マップの変更を容易にしておく。









