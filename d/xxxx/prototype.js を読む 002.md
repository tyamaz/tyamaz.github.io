---
title: prototype.js / 読む002
tags:
  - n/PGM/JavaScript/prototype.js/読む
---


ってことで第二回。一回にして最初のオブジェクト定義の半分しかいかなかった。
全3000行のうちまだ15行ほど・・・いつ終わるんだ


19行目〜ブラウザのモダンな機能をチェック
================================================================================
`BrowserFeatures` というものを定義しようとしている。
これも前回の `Browser` 同様でメンバの中にさらにオブジェクトが入れ子で入っている。
この `BrowserFeatures` は最新のブラウザが備えている機能をチェックしているように見える。

```javascript
BrowserFeatures: {
    XPath: !!document.evaluate,
    ElementExtensions: !!window.HTMLElement,
    SpecificElementExtensions:
      (document.createElement('div').__proto__ !==
       document.createElement('form').__proto__)
},
```

まずは `XPath`。
この `XPath` ってのはDOM版の `SQL` みたいなものと考えればいい。条件を指定してオブジェクトをズルりと取得する機能。
`Firefox` とか `Opera` とかは備えているようだが、`IE` はまったく未対応。つまり `IE` だったら `XPath` の機能は `false` が返るってこと。この `evaluate`に `XPath` 用の関数が格納されているようで、それの有無で`XPath` 使えるかどうか判定をしていると。

次は `ElementExtensions`。
Extensions というからには拡張ってことで・・・すべてのHTML要素の親クラスである HTMLElementがあるのか？ってこと？あったらなんなのよ？こいつを拡張すると要素を自由に作れる。

次は `SpecificElementExtensions`。
なんじゃこりゃ `div要素` と `form要素` を作って、そのプロトタイプが違っていると使える・・・。
`__proto__` キーワードは `Firefox` 独自で `prototypeチェーン` の先のオブジェクトを手繰り寄せるキーワード。

`prototypeオブジェクト` はプロトタイプチェーンに組み入れるときに使うプロパティ。
・・・深すぎてよくわからない、後々。

27行目〜スクリプト部をヒットさせる元ネタ
================================================================================
次は `ScriptFragment` というものを作っている。
内部スクリプトタグにヒットさせる正規表現（not 正規表現オブジェクト）に見える

```javascript
ScriptFragment: '<script[^>]*>([\\S\\s]*?)<\/script>',
```

これは `JavaScript` の文字列としてのエスケープと正規表現のエスケープが被っているので、元に戻すと、こう

```
<script[^>]*>([\S\s]*?)<\/script>
```

- `<script` で始まって
- ``>``」以外の連続　つまり属性指定があり
- 改行を含むすべての文字の連続の控えめヒット

テクニックとして

```
[\S\s]
```

は改行含むのなんでもヒットになる

```
.*?
```

では改行文字にマッチせずに改行部で連続マッチが止まってしまうので、複数行マッチさせるためにこのような書き方になっている

`</script>` で終わる。

タグの中がキャプチャになってるので中のJavascriptコードを何かに利用するのだろう。

28行目〜JSON抽出
================================================================================
これは後の `Stringオブジェクト` の拡張のところで使われる、JSONを抽出するものなんですが、完全に内部用なのであまり気にしなくてもいいかも。


```javascript
  JSONFilter: /^\/\*-secure-([\s\S]*)\*\/\s*$/,
```

こういうのは関数内部に隠蔽しろよともつっこみたくなりますがね

30行目〜空っぽ関数オブジェクト
================================================================================
空っぽの関数オブジェクトそのもの・・・何に使うんでしょうか？
実行しても何も起こらないので・・・おそらく何かのタイミングでオブジェクトを押し込む何かとして利用しそうな予感はします。先に進む。

```javascript
emptyFunction: function() { },
```

追記：多分ダミー用の関数で、関数オブジェクトが必要な場合のメソッド内でエラーを出さないために便宜的に渡すものだと思われる

31行目〜エコー関数
================================================================================
これも存在理由不明の、入力をそのままリターンする関数です。
関数オブジェクトのリターンとオブジェクトを同様に処理したいときにこのような関数を噛ますと型チェックの判定が減って記述が減るのかも

```javascript
K: function(x) { return x }
```

まとめ・・・わからんこと多すぎてまとまらない
================================================================================

-ブラウザのクセだけでなく、新機能に関しても特定のオブジェクトの有無により判定できる
- `__proto__` はFirefoxの拡張で `prototypeチェーン` の先のオブジェクトを指す。
- `prototype` はプロトタイプチェーンにオブジェクトを組み入れるためのプロパティであるだけで、中身は単なるオブジェクト

