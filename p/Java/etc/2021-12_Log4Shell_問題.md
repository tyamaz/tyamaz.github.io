---
title: 2021年12月 Log4Shell 問題
---

2021年12月付近に大きな問題になった `Log4j2` の脆弱性を利用した任意のコード実行できるやつ。
適当に調べた結果を適当にまとめた。

- [Log4j – Apache Log4j 2](https://logging.apache.org/log4j/2.x/)


この問題は `CVE-2021-44228`、 通称 `Log4Shell` となっている。`Log4j` というのが Logging For Java で今回はこの問題がシステムのシェルコマンドを実行するために用いられたので `Log4Shell` とは上手いネーミング。



なぜ大きな問題になったか？
================================================================================

Java 環境を対象としていた
--------------------------------------------------------------------------------
`Java` はサーバサイドの実装する環境としてはメジャーなのでその範囲が大きかった

ロギングライブラリの脆弱性を利用していた
--------------------------------------------------------------------------------
`Log4j2` というのは `Java` のロギングライブラリであり、サーバサイドの `Java` では広く使われていた。

ロギングというのはログを取ることであり、サーバサイドのプログラムでは問題が起きた場合の追跡のためにほぼ100％ぐらいログを記録している。そこで使われるライブラリが `Log4j` の `version 2` だったということ。

ログの記録というのは簡単に言うとテキストファイルに単に書けと言われたことをズラズラ書くだけであって、あまり特徴を出しにくいプログラムで、そんなに沢山の種類が存在しない。なのでみんな `Log4j` 使ってましたということ。

攻撃方法が非常に簡単かつ破壊力抜群だった
--------------------------------------------------------------------------------
攻撃用のプログラムをインターネットに設置して、その URL を攻撃対象のサーバにログで記録させればいいという超簡単なモノだった。

この攻撃用プログラムは非常に簡単で、Javaプログラマなら誰でも作れそうなモノ。Javaというのは汎用言語なので、基本的にコンピュータのことは大体制御可能。しかもそれがモロに実行されるだけなので破壊力抜群だった。
それをインターネットに置けばいい。置く自体は誰の管理があることでもないので、誰でもできる。

後はログに記録させればいいので、ログに記録されそうな情報の中に攻撃用の URL を入れ込んでおけば、真面目なサーバならそれを勝手に記録してくれるという寸法である。攻撃するほうは条件だけ整えたらあとは単にアクセスしまくるだけで攻撃できてしまう。



攻撃のポイント
================================================================================
どう攻撃するのか？今回 `Log4j2` の何が不味かったか？


脆弱ポイント1: 外部からのパラメータと内部での指示を区別してない
--------------------------------------------------------------------------------
まず1つが展開する変数の展開情報を外部からうけつけてしまっていたということ。

ログを記録する場合に、与えられた文字列そのままではなくて、ログの一部を動的な値にしたいという場合がある。この時にその部分を特定の記法をすることでログを書き込む時に `Log4j2` が置換するというモノ。

簡単に説明すると `Log4j2` に対して、

```
${hogehoge} あいうえお
```

とログを記録しろと指示したら、`Log4j2` は `${hogehoge}` という部分を、プログラムから指示を与えた値に置換する。ここに `かきくけこ` とパラメータが来た場合、`かきくけこ あいうえお` とログとして記録されるわけだ。

その特定の記法をプログラムから与えるのなら問題ないが、それが外部から来たモノと区別してなかった。元々そのような指示なのか、外部から来た値なのかの区別がなかった。

```
${hogehoge} あいうえお
```

に対して、`かき${hogehoge}${hogehoge}くけこ` とログを記録する場合、結果として

```
かき${hogehoge}${hogehoge}くけこ あいうえお
```

となり元々の指示が書き換わってしまう。ここで、`Log4j2` は最初から `かき${hogehoge}${hogehoge}くけこ あいうえお` だったのか、外部からの影響で `かき${hogehoge}${hogehoge}くけこ あいうえお` になったのか区別しないというのだ。




脆弱ポイント2: 外部から任意のプログラムをロードしてしまう
--------------------------------------------------------------------------------
上記の値埋め込み記述を任意のモノを入れられるという問題だけなら危なげはあるが実質攻撃に繋がることにはならない。`Log4j2` はここにある特別な記述 `JNDI Lookup` という機能を使って外部の値を埋め込めるとうことが可能になっていた。これは別に裏技でもなんでもなく普通に機能として提供されていた。

`JNDI` というのはなんらかの「名前」を参照するという機能になる。ログになんらかの名前を埋め込みたいという気持ちはわからんでもない。

この「名前」を提供する側は様々なモノが使えるようになっていて、そのなかには `LDAP` や `RMI` というモノがあった。どちらも結局なんらかの情報を提供することには変わりないがその手段に問題があった。

これらは、離れたコンピュータ上の情報を提供する手段(手順)としてオブジェクトを提供するという手段をとっており、オブジェクトを受け取った側はそれを自分のシステムにロードして使えるという仕組みである。

Java ではオブジェクトの内容はクラスとして定義されていて、クラスは単純な情報だけでなくなんらかの処理も書けるようになっている。だったら「名前」なんていう単なる値じゃなくて、処理を埋め込んだクラスを送り込めば好きな処理が実行できるだろうという仕掛け。

ここまでは `JNDI` の「機能」の話。そしてこいつが、ログの書き込み時に解釈されてしまうというのが `Log4j2` の問題。

ネット上のリモートのクラスを動的にロードするなんていう機能がなんでロギングライブラリに必要なのか首をかしげたくなるが、実装してしまっていたようだ。これが2つ目。


攻撃の流れ
================================================================================

- Log4j2 はリモートのクラスをなんでもロードするらしい
- ログに特定の文字列を書き込ませればその仕組みが動くらしい
- ログなのでサーバ側も無頓着に書き込んでくれるだろう
- 攻撃者は Java のクラスを用意する
  - Java のクラスには初期化部分(static イニシャライザ等)を書くことができて、クラスのロードに合わせて Java コードを実行できるように簡単に書ける。当然その中にシステムを制御するコードも書ける。
- 攻撃者は作ったクラスをインターネット上に置く(LDAP, RMI で提供)
- 攻撃者は攻撃対象に設置したJavaクラスのURLを送り込む
  - 攻撃対象のシステムが掲示板なら書き込んだ情報を全部保存している可能性もあるので、攻撃は簡単に「掲示板にアドレスを特定の記法で書き込む」のみになる
- 攻撃対象のサーバで特定の記法で書かれたURLがログに書き込まれる
- 書き込まれる際に特定記法部分が `JNDI` で解釈され動作する
- 動作した結果 URL に指定された、攻撃者の Java のクラスを取ってくる
- 攻撃者のクラスが Java システム上にロードされる
- 攻撃者のクラスの初期化部分が動作しシステムに損害を与える

酷いね。




いろいろ問題
================================================================================
この攻撃自体も問題なのだが、それ以外の問題も表面化した。


メンテが適当問題
--------------------------------------------------------------------------------
このような多数のシステムに使われるような重要なライブラリが、
数人のプログラマによってほぼ趣味でメンテナンスされているということ。

趣味なので、責任も無いし、義務でも無い。死に至る機能を作り込んだとしても知ったことじゃない。

- [Apache Log4jの脆弱性とともに浮かび上がったオープンソースのメンテナの責任範囲の問題 \- YAMDAS現更新履歴](https://yamdas.hatenablog.com/entry/20211222/apache-log4j)

たまたまダムの隣に住んでいたので普段はボランティアで水門調整してたら、決壊した時にどうにかしろみたいな。

