---
title: 2021年12月 Log4jShell 問題
---

2021年12月付近に大きな問題になった Log4j2 の脆弱性を利用した任意のコード実行できるやつ

適当に調べた結果を適当にまとめた

なぜ大きな問題になったか？
================================================================================

Java 環境を対象としていた
--------------------------------------------------------------------------------
Java はサーバサイドの実装する環境としてはメジャーだったのでその範囲が大きかった

ロギングライブラリを対象としていた
--------------------------------------------------------------------------------
Log4j2 というのはロギングライブラリであり、サーバサイドの Java では広く使われていた。

ロギングというのはログを取ることであり、サーバサイドのプログラムでは問題が起きた場合の追跡のためにほぼ100％ぐらいログを取って記録している。そこで使われるライブラリが Log4j の version 2 だったということ。

ログの記録というのは簡単に言うとテキストファイルに単に書けと言われたことをズラズラ書くだけであって、あまり特徴を出しにくいプログラムで、そんなに沢山の種類が存在しない。なのでみんな Log4j 使ってましたということ。

攻撃方法が非常に簡単かつ破壊力抜群だった
--------------------------------------------------------------------------------
Java のプログラムをインターネットに置いておいて、そのアドレスを攻撃対象のサーバにログで記録させればいいという超簡単なモノだった。

この Java プログラムは非常に簡単で、Javaプログラマなら誰でも作れそうなモノ。Javaというのは汎用言語なので、基本的にコンピュータのことは大体制御可能。しかもそれがモロに実行されるだけなので破壊力抜群だった。

それをインターネットに置けばいい。別にこんなの誰でもできる。
どこかの掲示板にでもファイルをアップするだけである。

後はログに記録させればいいので、なんらかのアクセス情報か入力にそのアドレスを入れ込んでおけば、真面目なサーバならそれを勝手に記録してくれるという寸法である。

攻撃するほうは条件だけ整えたらあとは単にアクセスしまくるだけでジャンジャン攻撃できてしまうという



攻撃の流れ
================================================================================

今回 Log4j2 の何が不味かったかというと、まず1つが展開する変数の展開情報を外部からうけつけてしまっていたということ。

ログを記録する場合に、与えられた文字列そのままではなくて、あるログの一部をある動的な値に置換したいという場合がある。この時にその部分を特定の記法をすることでログを書き込む時に Log4j が置換するというモノ。

その特定の記法をプログラムから与えるのなら問題ないが、それが外部から来たモノと区別してなかった。元々そのような値なのか、プログラムからの指示なのかの区別がなかった。これが1つ。


ここでこの埋め込み部分はプログラムの値を取ってくることになるので、一部のプログラムを解釈してしまうという問題があった。Log4j2 には JNDI という機能があって、JNDI というのはリモートにある Java クラスをロードするというモノになる。ネット上のリモートのクラスを動的にロードするなんていう機能がなんでロギングライブラリに必要なのか首をかしげたくなるが、実装してしまっていたようだ。これが2つ目。

- Log4j2 はリモートのクラスをなんでもロードするらしい
- ログに特定の文字列を書き込ませればその仕組みが動くらしい
- ログなのでサーバ側も無頓着に書き込んでくれるだろう
- 攻撃者は Java のクラスを用意する
  - Java のクラスには初期化部分(static イニシャライザ等)を書くことができて、クラスのロードに合わせて Java コードを実行できるように簡単に書ける。当然その中にシステムを制御するコードも書ける。
- 攻撃者は作ったクラスをインターネット上に置く
- 攻撃者は攻撃対象に設置したJavaクラスのURLを送り込む
  - 攻撃対象のシステムが掲示板なら書き込んだ情報を全部保存している可能性もあるので、攻撃は簡単に「掲示板にアドレスを特定の記法で書き込む」のみになる
- 攻撃対象のサーバで特定の記法で書かれたURLがログに書き込まれる
- 書き込まれる際に特定記法部分がプログラムで解釈される
- 解釈された結果 URL に指定された、攻撃者の Java のクラスを取ってくる
- 攻撃者のクラスが Java システム上にロードされる
- 攻撃者のクラスの初期化部分が動作しシステムに損害を与える

酷いね。























攻撃者は Java のクラスファイルを用意してインターネットに設置する













